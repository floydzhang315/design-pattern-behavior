## 处理对象的多种状态及其相互转换——状态模式（六）  

**6 状态模式总结**  

状态模式将一个对象在不同状态下的不同行为封装在一个个状态类中，通过设置不同的状态对象可以让环境对象拥有不同的行为，而状态转换的细节对于客户端而言是透明的，方便了客户端的使用。在实际开发中，状态模式具有较高的使用频率，在工作流和游戏开发中状态模式都得到了广泛的应用，例如公文状态的转换、游戏中角色的升级等。  

**1. 主要优点**  

状态模式的主要优点如下：  

(1) **封装了状态的转换规则**，在状态模式中可以将状态的转换代码封装在环境类或者具体状态类中，可以对状态转换代码进行集中管理，而不是分散在一个个业务方法中。  

(2) **将所有与某个状态有关的行为放到一个类中**，只需要注入一个不同的状态对象即可使环境对象拥有不同的行为。  

(3) **允许状态转换逻辑与状态对象合成一体，而不是提供一个巨大的条件语句块**，状态模式可以让我们避免使用庞大的条件语句来将业务方法和状态转换代码交织在一起。  

(4) 可以**让多个环境对象共享一个状态对象**，从而减少系统中对象的个数。  

**2. 主要缺点**  

状态模式的主要缺点如下：  

(1) 状态模式的使用**必然会增加系统中类和对象的个数，导致系统运行开销增大**。  

(2) 状态模式的结构与实现都较为复杂，**如果使用不当将导致程序结构和代码的混乱，增加系统设计的难度**。  

(3) 状态模式**对“开闭原则”的支持并不太好**，增加新的状态类需要修改那些负责状态转换的源代码，否则无法转换到新增状态；而且修改某个状态类的行为也需修改对应类的源代码。  

**3. 适用场景**  

在以下情况下可以考虑使用状态模式：  

(1) 对象的行为依赖于它的状态（如某些属性值），状态的改变将导致行为的变化。  

(2) 在代码中包含大量与对象状态有关的条件语句，这些条件语句的出现，会导致代码的可维护性和灵活性变差，不能方便地增加和删除状态，并且导致客户类与类库之间的耦合增强。  

**练习**  
Sunny 软件公司欲开发一款纸牌游戏软件，在该游戏软件中用户角色具有入门级（Primary）、熟练级（Secondary）、高手级（Professional）和骨灰级（Final）四种等级，角色的等级与其积分相对应，游戏胜利将增加积分，失败则扣除积分。入门级具有最基本的游戏功能 play() ，熟练级增加了游戏胜利积分加倍功能 doubleScore()，高手级在熟练级基础上再增加换牌功能changeCards()，骨灰级在高手级基础上再增加偷看他人的牌功能 peekCards()。  
试使用状态模式来设计该系统。
 
**7 练习**  

(1) 分析如下代码：  

```
class TestXYZ {
    int behaviour;
    //Getter and Setter
    ......
    public void handleAll() {
        if (behaviour == 0) { //do something }
        else if (behaviour == 1) { //do something }
        else if (behaviour == 2) { //do something }
        else if (behaviour == 3) { //do something }
        ... some more else if ...
    }
}
```

为了提高代码的扩展性和健壮性，可以使用(    )设计模式来进行重构。  
        A. Visitor（访问者）  
        B. Facade（外观）  
        C. Memento（备忘录）  
        D. State（状态）  

 
(2) 传输门是传输系统中的重要装置。传输门具有 Open（打开）、Closed（关闭）、Opening（正在打开）、StayOpen（保持打开）、Closing（正在关闭）五种状态。触发状态的转换事件有 click、complete 和 timeout 三种。事件与其相应的状态转换如图所示。

![传输门响应事件与其状态转换图](images/1358695550_1995.jpg)  

试使用状态模式对传输门进行状态模拟，要求绘制相应的类图并编程模拟实现。